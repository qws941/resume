name: Vault OIDC Test

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/vault-test.yml'

env:
  VAULT_ADDR: ${{ secrets.VAULT_ADDR }}

jobs:
  test-vault-oidc:
    runs-on: [self-hosted, linux, x64, proxmox]
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Fetch Secrets from Vault
        uses: hashicorp/vault-action@4c06c5ccf5c0761b6029f56cfb1dcf5565918a3b # v3
        with:
          url: ${{ env.VAULT_ADDR }}
          method: jwt
          role: github-actions
          jwtGithubAudience: 'https://github.com/qws941'
          secrets: |
            secret/data/mcp/test api_key | MCP_API_KEY
            secret/data/mcp/test service_name | MCP_SERVICE
            secret/data/infra/test db_password | INFRA_PASSWORD
            secret/data/infra/test environment | INFRA_ENV

      - name: Verify Secrets
        run: |
          echo "=== Vault OIDC Test Results ==="
          echo "MCP_API_KEY is set: ${MCP_API_KEY:+YES}"
          echo "MCP_SERVICE: $MCP_SERVICE"
          echo "INFRA_PASSWORD is set: ${INFRA_PASSWORD:+YES}"
          echo "INFRA_ENV: $INFRA_ENV"

          if [ -n "$MCP_API_KEY" ] && [ -n "$INFRA_PASSWORD" ]; then
            echo "✅ All secrets fetched successfully!"
            exit 0
          else
            echo "❌ Some secrets are missing"
            exit 1
          fi
