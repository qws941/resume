# =============================================================================
# MAINTENANCE - MANUAL JOBS
# =============================================================================
# Handles:
#   - Auth session refresh for job platforms
#   - Profile data sync
#   - Infrastructure drift detection
#   - Cache cleanup
#
# Trigger: Manual workflow_dispatch only
# =============================================================================

name: Maintenance

on:
  schedule:
    # Weekly drift detection: Monday 6:00 UTC (15:00 KST)
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      job:
        description: 'Job to run'
        required: true
        type: choice
        options:
          - auth-refresh
          - profile-sync
          - drift-detection
          - cache-cleanup
          - all

env:
  NODE_VERSION: '22'

jobs:
  # ===========================================================================
  # AUTH REFRESH - Keep job platform sessions alive
  # ===========================================================================
  auth-refresh:
    name: Auth Session Refresh
    runs-on: ubuntu-latest
    if: inputs.job == 'auth-refresh' || inputs.job == 'all'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Refresh auth sessions
        env:
          AUTH_SYNC_SECRET: ${{ secrets.AUTH_SYNC_SECRET }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          JOB_DASHBOARD_URL: 'https://resume.jclee.me/job'
        run: |
          echo "=== Refreshing Auth Sessions ==="

          # Call the job dashboard auth refresh endpoint
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${JOB_DASHBOARD_URL}/api/auth/refresh" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${AUTH_SYNC_SECRET}" \
            -d '{"action": "refresh_all"}')

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Auth refresh successful"
            echo "$BODY" | jq . 2>/dev/null || echo "$BODY"
          else
            echo "‚ö†Ô∏è Auth refresh returned HTTP $HTTP_CODE"
            echo "$BODY"
            # Don't fail - auth refresh failure is non-critical
          fi

      - name: Post summary
        run: |
          echo "## Auth Refresh Complete ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # PROFILE SYNC - Sync resume data across platforms
  # ===========================================================================
  profile-sync:
    name: Profile Data Sync
    runs-on: ubuntu-latest
    if: inputs.job == 'profile-sync' || inputs.job == 'all'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Sync profile data
        env:
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
          JOB_DASHBOARD_URL: 'https://resume.jclee.me/job'
        run: |
          echo "=== Syncing Profile Data ==="

          # Sync resume data to SSoT
          npm run sync:data || true

          # Call the profile sync endpoint
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${JOB_DASHBOARD_URL}/api/profile/sync" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d '{"source": "github_actions"}')

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Profile sync successful"
            echo "$BODY" | jq . 2>/dev/null || echo "$BODY"
          else
            echo "‚ö†Ô∏è Profile sync returned HTTP $HTTP_CODE"
            echo "$BODY"
          fi

      - name: Post summary
        run: |
          echo "## Profile Sync Complete ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # DRIFT DETECTION - Check for infrastructure drift
  # ===========================================================================
  drift-detection:
    name: Infrastructure Drift Detection
    runs-on: ubuntu-latest
    if: inputs.job == 'drift-detection' || inputs.job == 'all' || github.event_name == 'schedule'
    env:
      TF_VERSION: '1.6.0'
      TF_WORKING_DIR: 'infrastructure/cloudflare'
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      # Terraform S3 backend (Cloudflare R2)
      AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      AWS_ENDPOINT_URL_S3: https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          for i in 1 2 3; do
            if terraform init -input=false; then
              echo "‚úÖ terraform init succeeded"
              exit 0
            fi
            echo "::warning::terraform init attempt $i/3 failed, retrying in ${i}0s..."
            sleep ${i}0
          done
          echo "::error::terraform init failed after 3 attempts"
          exit 1
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Check for Drift
        id: drift
        run: |
          set +e
          terraform plan -detailed-exitcode -no-color 2>&1 | tee drift_output.txt
          EXITCODE=$?

          if [ $EXITCODE -eq 2 ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "::warning::Infrastructure drift detected!"
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No drift detected"
          fi
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Create Issue for Drift
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const driftOutput = fs.readFileSync('${{ env.TF_WORKING_DIR }}/drift_output.txt', 'utf8');

            // Check for existing drift issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'infrastructure,drift',
              state: 'open'
            });

            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## Drift Still Present (${new Date().toISOString()})
                
                \`\`\`hcl
                ${driftOutput.substring(0, 30000)}
                \`\`\``
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '‚ö†Ô∏è Infrastructure Drift Detected',
                body: `## Infrastructure Drift Detected
                
                Terraform detected differences between the state and actual infrastructure.
                
                <details>
                <summary>Drift Details</summary>
                
                \`\`\`hcl
                ${driftOutput.substring(0, 60000)}
                \`\`\`
                
                </details>
                
                **Action Required:** Review and either update Terraform configuration or apply to reconcile.
                
                ---
                *Detected by scheduled drift detection*`,
                labels: ['infrastructure', 'drift', 'needs-review']
              });
            }

      - name: Post summary
        run: |
          if [ "${{ steps.drift.outputs.drift_detected }}" == "true" ]; then
            echo "## Drift Detection ‚ö†Ô∏è" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** Drift detected - issue created" >> $GITHUB_STEP_SUMMARY
          else
            echo "## Drift Detection ‚úÖ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** No drift detected" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # CACHE CLEANUP - Clean up old caches
  # ===========================================================================
  cache-cleanup:
    name: Cache Cleanup
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && (inputs.job == 'cache-cleanup' || inputs.job == 'all'))
    steps:
      - name: Cleanup old caches
        uses: actions/github-script@v8
        with:
          script: |
            const caches = await github.rest.actions.getActionsCacheList({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const now = new Date();
            const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 days
            let deletedCount = 0;

            for (const cache of caches.data.actions_caches || []) {
              const cacheDate = new Date(cache.created_at);
              const age = now - cacheDate;
              
              if (age > maxAge) {
                try {
                  await github.rest.actions.deleteActionsCacheById({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    cache_id: cache.id
                  });
                  deletedCount++;
                  console.log(`Deleted cache: ${cache.key}`);
                } catch (e) {
                  console.log(`Failed to delete cache ${cache.key}: ${e.message}`);
                }
              }
            }

            console.log(`Deleted ${deletedCount} old caches`);

      - name: Post summary
        run: |
          echo "## Cache Cleanup Complete üßπ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # NOTIFY - Send notification on failure
  # ===========================================================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [auth-refresh, profile-sync, drift-detection, cache-cleanup]
    if: failure()
    steps:
      - name: Send failure notification
        env:
          N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
        run: |
          if [ -n "$N8N_WEBHOOK_URL" ]; then
            curl -X POST "$N8N_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d '{
                "status": "failure",
                "workflow": "maintenance",
                "repository": "${{ github.repository }}",
                "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "message": "Maintenance job failed - check logs"
              }' || echo "Webhook failed"
          fi
