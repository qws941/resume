# =============================================================================
# RESUME MONOREPO - CI VALIDATION PIPELINE
# =============================================================================
# =============================================================================

name: CI Validation Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (manual validation run only)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '22'
  GITLEAKS_VERSION: '8.22.1'

permissions:
  contents: read
  actions: read

concurrency:
  group: ${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || format('ci-{0}', github.ref) }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # STAGE: ANALYZE - Affected Target Analysis
  # ===========================================================================
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    outputs:
      portfolio_affected: ${{ steps.affected.outputs.portfolio }}
      job_dashboard_affected: ${{ steps.affected.outputs.job_dashboard }}
      data_affected: ${{ steps.affected.outputs.data }}
      infra_affected: ${{ steps.affected.outputs.infra }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Determine affected targets
        id: affected
        run: |
          chmod +x tools/ci/affected.sh

          if [ "${{ github.event_name }}" = "push" ]; then
            BASE_REF="${{ github.event.before }}"
            if [ "$BASE_REF" = "0000000000000000000000000000000000000000" ]; then
              BASE_REF="HEAD~1"
            fi
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="origin/${{ github.base_ref }}"
          else
            BASE_REF="HEAD~1"
          fi

          echo "Using base ref: $BASE_REF"
          ./tools/ci/affected.sh "$BASE_REF"

          if [ -f .affected/affected_targets.json ]; then
            PORTFOLIO=$(jq -r '.portfolio // false' .affected/affected_targets.json)
            JOB_DASHBOARD=$(jq -r '.job_dashboard // false' .affected/affected_targets.json)
            DATA=$(jq -r '.data // false' .affected/affected_targets.json)
            INFRA=$(jq -r '.infra // false' .affected/affected_targets.json)
          else
            CHANGED_FILES=$(git diff --name-only "$BASE_REF"...HEAD 2>/dev/null || git diff --name-only HEAD~1)
            PORTFOLIO=$(echo "$CHANGED_FILES" | grep -q "typescript/portfolio-worker\|typescript/data" && echo "true" || echo "false")
            JOB_DASHBOARD=$(echo "$CHANGED_FILES" | grep -q "typescript/job-automation" && echo "true" || echo "false")
            DATA=$(echo "$CHANGED_FILES" | grep -q "typescript/data" && echo "true" || echo "false")
            INFRA=$(echo "$CHANGED_FILES" | grep -q "infrastructure/" && echo "true" || echo "false")
          fi

          echo "portfolio=$PORTFOLIO" >> $GITHUB_OUTPUT
          echo "job_dashboard=$JOB_DASHBOARD" >> $GITHUB_OUTPUT
          echo "data=$DATA" >> $GITHUB_OUTPUT
          echo "infra=$INFRA" >> $GITHUB_OUTPUT

          echo "ðŸ“Š Affected targets:"
          echo "  - Portfolio: $PORTFOLIO"
          echo "  - Job Dashboard: $JOB_DASHBOARD"
          echo "  - Data: $DATA"
          echo "  - Infrastructure: $INFRA"

  # ===========================================================================
  # STAGE: VALIDATE - Linting & Type Checking
  # ===========================================================================
  validate-cloudflare:
    name: Cloudflare Native Validation
    runs-on: ubuntu-latest
    needs: [analyze]
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Validate Cloudflare native structure
        run: |
          chmod +x tools/ci/validate-cloudflare-native.sh
          ./tools/ci/validate-cloudflare-native.sh

      - name: Setup
        uses: ./.github/actions/setup

      - name: Validate wrangler types generation
        run: |
          npx wrangler types /tmp/portfolio-worker-types.d.ts --config typescript/portfolio-worker/wrangler.toml --env production

  lint:
    name: ESLint
    runs-on: ubuntu-latest
    needs: [analyze]
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Run ESLint
        run: |
          echo "=== Running ESLint ==="
          npm run lint 2>&1 | tee eslint-results.txt || true

          ERRORS=$(grep -oP '\(\K[0-9]+(?= errors?[,)])' eslint-results.txt | tail -1 || echo "0")
          WARNINGS=$(grep -oP '[0-9]+(?= warnings?\))' eslint-results.txt | tail -1 || echo "0")

          echo "Lint: ${ERRORS:-0} errors, ${WARNINGS:-0} warnings"

          if [ "${ERRORS:-0}" -gt "0" ]; then
            echo "âŒ ESLint found errors - failing"
            exit 1
          fi

          # Quality gate: Zero-tolerance ratchet (baseline in .eslint-baseline file)
          ESLINT_WARNING_BASELINE=$(cat .eslint-baseline 2>/dev/null || echo 0)
          if [ "${WARNINGS:-0}" -gt "$ESLINT_WARNING_BASELINE" ]; then
            echo "âŒ ESLint warnings increased (${WARNINGS} > ${ESLINT_WARNING_BASELINE}) - fix new warnings before merging"
            exit 1
          elif [ "${WARNINGS:-0}" -lt "$ESLINT_WARNING_BASELINE" ]; then
            echo "ðŸŽ‰ Warnings decreased! Update baseline: echo ${WARNINGS} > .eslint-baseline"
          fi

          echo "âœ… Lint passed"

      - name: Upload lint results
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: eslint-results
          path: eslint-results.txt
          retention-days: 7

  typecheck:
    name: TypeScript Check
    runs-on: ubuntu-latest
    needs: [analyze]
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Run TypeScript check
        run: |
          echo "=== Running TypeScript Check ==="
          npm run typecheck

  # ===========================================================================
  # STAGE: TEST - Unit & E2E Tests
  # ===========================================================================
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [analyze]
    if: ${{ !inputs.skip_tests }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Run all unit tests (Jest + node:test)
        run: |
          echo "=== Running All Unit Tests ==="
          npm test

      - name: Generate coverage reports
        run: |
          echo "=== Generating Coverage ==="
          npm run test:coverage

      - name: Upload coverage
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7
          if-no-files-found: ignore

  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [analyze]
    if: ${{ !inputs.skip_tests }}
    continue-on-error: false
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup
        uses: ./.github/actions/setup
        with:
          install-playwright: 'true'

      # NOTE: Intentionally duplicates sync:data + build from the build job.
      # E2E tests need a running local dev server (via wrangler/miniflare) for
      # Playwright to hit, so they MUST build locally â€” downloading the build
      # artifact alone is not sufficient. This trades ~2min CI time for pipeline
      # parallelism (E2E runs alongside lint/typecheck/unit, not after build).
      # See: playwright.config.js webServer config.
      - name: Sync resume data
        run: npm run sync:data

      - name: Build portfolio worker
        run: npm run build
        working-directory: typescript/portfolio-worker

      - name: Run smoke E2E tests against local build
        run: npm run test:e2e:smoke
        env:
          CI: true

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
          if-no-files-found: ignore

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [analyze]
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Install gitleaks
        run: |
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v${{ env.GITLEAKS_VERSION }}/gitleaks_${{ env.GITLEAKS_VERSION }}_linux_x64.tar.gz | tar xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run gitleaks
        run: gitleaks detect --source . --config .gitleaks.toml --verbose --no-git

      - name: Setup
        uses: ./.github/actions/setup

      - name: Run npm audit
        run: npm audit --audit-level=high || echo "::warning::npm audit found vulnerabilities"

  # ===========================================================================
  # STAGE: BUILD
  # ===========================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test-unit, validate-cloudflare]
    if: >-
      !cancelled() &&
      !failure()
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Sync resume data
        run: npm run sync:data

      - name: Build portfolio worker
        run: npm run build
        working-directory: typescript/portfolio-worker

      - name: Upload build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: portfolio-worker
          path: typescript/portfolio-worker/worker.js
          retention-days: 7

  # ===========================================================================
  # STAGE: OBSERVABILITY - ELK Ingest
  # ===========================================================================
  elk-ingest:
    name: ELK Ingest
    needs: [analyze, validate-cloudflare, lint, typecheck, test-unit, test-e2e, security-scan, build]
    if: always() && !cancelled()
    runs-on: ${{ vars.RUNNER || 'ubuntu-latest' }}
    timeout-minutes: 2
    steps:
      - name: Index event to Elasticsearch
        continue-on-error: true
        env:
          ELASTICSEARCH_URL: ${{ vars.ELASTICSEARCH_URL }}
          ELASTICSEARCH_API_KEY: ${{ secrets.ELASTICSEARCH_API_KEY }}
          INPUT_CONCLUSION: >-
            ${{
              contains(needs.*.result, 'failure') && 'failure' ||
              contains(needs.*.result, 'cancelled') && 'cancelled' ||
              'success'
            }}
          INPUT_INDEX_PREFIX: github-actions
          INPUT_SERVICE: resume
          INPUT_EXTRA_FIELDS: '{}'
          GH_REPO: ${{ github.repository }}
          GH_WORKFLOW: ${{ github.workflow }}
          GH_RUN_ID: ${{ github.run_id }}
          GH_RUN_NUMBER: ${{ github.run_number }}
          GH_RUN_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          GH_REF_NAME: ${{ github.ref_name }}
          GH_SHA: ${{ github.sha }}
          GH_ACTOR: ${{ github.actor }}
          GH_EVENT: ${{ github.event_name }}
        run: |
          if [ -z "$ELASTICSEARCH_URL" ]; then
            echo "::warning::ELASTICSEARCH_URL not configured â€” skipping ELK ingest"
            exit 0
          fi

          SERVICE="${INPUT_SERVICE:-${GH_REPO##*/}}"
          INDEX="${INPUT_INDEX_PREFIX}-$(date -u +%Y.%m.%d)"

          PAYLOAD=$(jq -n \
            --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg repo "$GH_REPO" \
            --arg workflow "$GH_WORKFLOW" \
            --arg run_id "$GH_RUN_ID" \
            --arg run_number "$GH_RUN_NUMBER" \
            --arg run_url "$GH_RUN_URL" \
            --arg conclusion "$INPUT_CONCLUSION" \
            --arg branch "$GH_REF_NAME" \
            --arg sha "$GH_SHA" \
            --arg actor "$GH_ACTOR" \
            --arg event "$GH_EVENT" \
            --arg service "$SERVICE" \
            --argjson extra "$INPUT_EXTRA_FIELDS" \
            '{
              "@timestamp": $ts,
              "service": $service,
              "github": {
                "repository": $repo,
                "workflow": $workflow,
                "run_id": ($run_id | tonumber),
                "run_number": ($run_number | tonumber),
                "run_url": $run_url,
                "conclusion": $conclusion,
                "branch": $branch,
                "sha": $sha,
                "sha_short": ($sha | .[0:7]),
                "actor": $actor,
                "event": $event
              }
            } + $extra')

          CURL_ARGS=(-s -o /tmp/es-response.json -w "%{http_code}" \
            -X POST "${ELASTICSEARCH_URL}/${INDEX}/_doc" \
            -H "Content-Type: application/json")

          if [ -n "$ELASTICSEARCH_API_KEY" ]; then
            CURL_ARGS+=(-H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}")
          fi

          CURL_ARGS+=(-d "$PAYLOAD")

          HTTP_CODE=$(curl "${CURL_ARGS[@]}")

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            DOC_ID=$(jq -r '._id // empty' /tmp/es-response.json)
            echo "Indexed to ${INDEX} (HTTP ${HTTP_CODE}, doc: ${DOC_ID})"
          else
            echo "::warning::ELK ingest failed (HTTP ${HTTP_CODE})"
            cat /tmp/es-response.json 2>/dev/null || true
          fi
