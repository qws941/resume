# GitHub Actions: Deployment Verification Workflow
# Purpose: Standalone verification workflow for deployment validation
# Triggers: Manual dispatch, called from deploy.yml
# Based on: tools/scripts/verification/verify-deployment-v2.sh (361 lines)

name: Verify Deployment

on:
  deployment_status:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to verify'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging
      portfolio_url:
        description: 'Portfolio URL to verify (default: https://resume.jclee.me)'
        required: false
        default: 'https://resume.jclee.me'
      job_dashboard_url:
        description: 'Job Dashboard URL to verify (default: https://resume.jclee.me/job)'
        required: false
        default: 'https://resume.jclee.me/job'
      timeout_seconds:
        description: 'Timeout for each curl request in seconds'
        required: false
        default: '30'

  workflow_call:
    inputs:
      portfolio_url:
        description: 'Portfolio URL to verify'
        required: false
        type: string
        default: 'https://resume.jclee.me'
      job_dashboard_url:
        description: 'Job Dashboard URL to verify'
        required: false
        type: string
        default: 'https://resume.jclee.me/job'
      timeout_seconds:
        description: 'Timeout for each curl request'
        required: false
        type: string
        default: '30'

permissions:
  contents: read
  actions: read

env:
  PORTFOLIO_URL: https://resume.jclee.me
  JOB_DASHBOARD_URL: https://resume.jclee.me/job

jobs:
  verify-portfolio:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call' || (github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success')
    name: Verify Portfolio (${{ matrix.check }})
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        check:
          - health
          - security-headers
          - content-integrity
          - performance
          - api-endpoints
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            .github

      - name: Set URLs
        id: urls
        shell: bash
        run: |
          PORTFOLIO_URL="${{ inputs.portfolio_url || github.event.inputs.portfolio_url || env.PORTFOLIO_URL }}"
          JOB_DASHBOARD_URL="${{ inputs.job_dashboard_url || github.event.inputs.job_dashboard_url || env.JOB_DASHBOARD_URL }}"
          TIMEOUT="${{ inputs.timeout_seconds || '30' }}"

          echo "portfolio_url=$PORTFOLIO_URL" >> $GITHUB_OUTPUT
          echo "job_dashboard_url=$JOB_DASHBOARD_URL" >> $GITHUB_OUTPUT
          echo "timeout=$TIMEOUT" >> $GITHUB_OUTPUT

          echo "üìç Portfolio URL: $PORTFOLIO_URL"
          echo "üìç Job Dashboard URL: $JOB_DASHBOARD_URL"
          echo "üìç Timeout: ${TIMEOUT}s"

      # ==================== HEALTH CHECKS ====================
      - name: 'Check: Portfolio Health Endpoint'
        if: matrix.check == 'health'
        shell: bash
        run: |
          set +e
          PORTFOLIO_URL="${{ steps.urls.outputs.portfolio_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"
          RETRIES=5
          DELAY=5
          UA='Mozilla/5.0 (GitHubActions VerifyDeployment; +https://github.com/qws941/resume)'

          echo "üè• Checking Portfolio Health..."

          for i in $(seq 1 $RETRIES); do
            echo "  Attempt $i/$RETRIES..."
            HEALTH=$(curl -fsSL --http1.1 --connect-timeout 10 --retry 3 --retry-delay 2 --retry-all-errors --max-time "$TIMEOUT" -A "$UA" -H 'Accept: application/json' "$PORTFOLIO_URL/health" 2>/dev/null)
            
            if [ $? -eq 0 ]; then
              STATUS=$(echo "$HEALTH" | jq -r '.status // "unknown"' 2>/dev/null)
              VERSION=$(echo "$HEALTH" | jq -r '.version // "unknown"' 2>/dev/null)
              DEPLOYED_AT=$(echo "$HEALTH" | jq -r '.deployed_at // "unknown"' 2>/dev/null)
              
              if [ "$STATUS" = "healthy" ]; then
                echo "‚úÖ Portfolio Health: $STATUS (v$VERSION, deployed: ${DEPLOYED_AT:0:19})"
                
                # Check deployment age
                if [ "$DEPLOYED_AT" != "unknown" ]; then
                  DEPLOYED_EPOCH=$(date -d "$DEPLOYED_AT" +%s 2>/dev/null || echo "0")
                  NOW_EPOCH=$(date +%s)
                  AGE_HOURS=$(( (NOW_EPOCH - DEPLOYED_EPOCH) / 3600 ))
                  
                  if [ $AGE_HOURS -gt 168 ]; then
                    echo "‚ö†Ô∏è  Deployment Age: ${AGE_HOURS}h old (>7 days)"
                  else
                    echo "‚úÖ Deployment Age: ${AGE_HOURS}h old"
                  fi
                fi
                exit 0
              elif [ "$STATUS" = "degraded" ]; then
                echo "‚ö†Ô∏è  Portfolio Health: degraded (v$VERSION, deployed: ${DEPLOYED_AT:0:19})"
                exit 0
              fi
            fi
            
            if [ $i -lt $RETRIES ]; then
              echo "  Retrying in ${DELAY}s..."
              sleep $DELAY
            fi
          done

          echo "‚ö†Ô∏è  Portfolio Health: Endpoint unreachable after $RETRIES attempts (non-blocking)"
          exit 0

      - name: 'Check: Job Dashboard Health Endpoint'
        if: matrix.check == 'health'
        shell: bash
        run: |
          set +e
          JOB_DASHBOARD_URL="${{ steps.urls.outputs.job_dashboard_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"

          echo "üè• Checking Job Dashboard Health..."

          if JOB_HEALTH=$(curl -sf --max-time "$TIMEOUT" "$JOB_DASHBOARD_URL/api/health" 2>/dev/null); then
            JOB_STATUS=$(echo "$JOB_HEALTH" | jq -r '.status // "unknown"' 2>/dev/null)
            JOB_VERSION=$(echo "$JOB_HEALTH" | jq -r '.version // "unknown"' 2>/dev/null)
            DB_STATUS=$(echo "$JOB_HEALTH" | jq -r '.database // "unknown"' 2>/dev/null)
            
            if [ "$JOB_STATUS" = "ok" ]; then
              echo "‚úÖ Job Dashboard Health: $JOB_STATUS (v$JOB_VERSION, DB: $DB_STATUS)"
              exit 0
            else
              echo "‚ö†Ô∏è  Job Dashboard Status: $JOB_STATUS (may be optional)"
              exit 0
            fi
          else
            echo "‚ö†Ô∏è  Job Dashboard Health: Endpoint unreachable (may be optional)"
            exit 0
          fi

      - name: 'Check: HTTP Response Time'
        if: matrix.check == 'health'
        shell: bash
        run: |
          set +e
          PORTFOLIO_URL="${{ steps.urls.outputs.portfolio_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"

          echo "‚è±Ô∏è  Measuring HTTP Response Time..."

          RESPONSE_TIME=$(curl -sf -o /dev/null -w "%{time_total}" --max-time "$TIMEOUT" "$PORTFOLIO_URL/" 2>/dev/null || echo "0")
          RESPONSE_MS=$(echo "$RESPONSE_TIME * 1000" | bc | cut -d. -f1)

          if [ "$RESPONSE_MS" -lt 500 ]; then
            echo "‚úÖ Response Time: ${RESPONSE_MS}ms (<500ms)"
            exit 0
          elif [ "$RESPONSE_MS" -lt 1000 ]; then
            echo "‚ö†Ô∏è  Response Time: ${RESPONSE_MS}ms (500-1000ms)"
            exit 0
          else
            echo "‚ùå Response Time: ${RESPONSE_MS}ms (>1000ms)"
            exit 1
          fi

      # ==================== SECURITY HEADERS ====================
      - name: 'Check: Content Security Policy (CSP)'
        if: matrix.check == 'security-headers'
        shell: bash
        run: |
          set +e
          PORTFOLIO_URL="${{ steps.urls.outputs.portfolio_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"
          UA='Mozilla/5.0 (GitHubActions VerifyDeployment; +https://github.com/qws941/resume)'

          echo "üîí Checking Content Security Policy..."

          HEADERS=$(curl -fsSIL --http1.1 --connect-timeout 10 --retry 3 --retry-delay 2 --retry-all-errors --max-time "$TIMEOUT" -A "$UA" "$PORTFOLIO_URL/" 2>/dev/null)

          if echo "$HEADERS" | grep -qi "content-security-policy"; then
            CSP=$(echo "$HEADERS" | grep -i "content-security-policy" | head -1)
            
            if echo "$CSP" | grep -q "script-src.*sha256"; then
              echo "‚úÖ CSP: Strict (SHA-256 hashes)"
              exit 0
            elif echo "$CSP" | grep -q "script-src.*unsafe-inline"; then
              echo "‚ö†Ô∏è  CSP: Uses unsafe-inline"
              exit 0
            else
              echo "‚úÖ CSP: Present"
              exit 0
            fi
          else
            echo "‚ö†Ô∏è  CSP: Missing or not exposed to this runner (non-blocking)"
            exit 0
          fi

      - name: 'Check: HSTS Header'
        if: matrix.check == 'security-headers'
        shell: bash
        run: |
          set +e
          PORTFOLIO_URL="${{ steps.urls.outputs.portfolio_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"
          UA='Mozilla/5.0 (GitHubActions VerifyDeployment; +https://github.com/qws941/resume)'

          echo "üîí Checking HSTS Header..."

          HEADERS=$(curl -fsSIL --http1.1 --connect-timeout 10 --retry 3 --retry-delay 2 --retry-all-errors --max-time "$TIMEOUT" -A "$UA" "$PORTFOLIO_URL/" 2>/dev/null)

          if echo "$HEADERS" | grep -qi "strict-transport-security"; then
            HSTS=$(echo "$HEADERS" | grep -i "strict-transport-security" | head -1)
            
            if echo "$HSTS" | grep -q "preload"; then
              echo "‚úÖ HSTS: With preload"
              exit 0
            else
              echo "‚ö†Ô∏è  HSTS: Without preload"
              exit 0
            fi
          else
            echo "‚ö†Ô∏è  HSTS: Missing or not exposed to this runner (non-blocking)"
            exit 0
          fi

      - name: 'Check: X-Content-Type-Options Header'
        if: matrix.check == 'security-headers'
        shell: bash
        run: |
          set +e
          PORTFOLIO_URL="${{ steps.urls.outputs.portfolio_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"

          echo "üîí Checking X-Content-Type-Options Header..."

          HEADERS=$(curl -sI --max-time "$TIMEOUT" "$PORTFOLIO_URL/" 2>/dev/null)

          if echo "$HEADERS" | grep -qi "x-content-type-options.*nosniff"; then
            echo "‚úÖ X-Content-Type-Options: nosniff"
            exit 0
          else
            echo "‚ùå X-Content-Type-Options: Missing or incorrect"
            exit 1
          fi

      - name: 'Check: X-Frame-Options Header'
        if: matrix.check == 'security-headers'
        shell: bash
        run: |
          set +e
          PORTFOLIO_URL="${{ steps.urls.outputs.portfolio_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"

          echo "üîí Checking X-Frame-Options Header..."

          HEADERS=$(curl -sI --max-time "$TIMEOUT" "$PORTFOLIO_URL/" 2>/dev/null)

          if echo "$HEADERS" | grep -qi "x-frame-options"; then
            XFRAME=$(echo "$HEADERS" | grep -i "x-frame-options" | head -1 | tr -d '\r')
            echo "‚úÖ X-Frame-Options: ${XFRAME#*: }"
            exit 0
          else
            echo "‚ö†Ô∏è  X-Frame-Options: Missing (CSP frame-ancestors may cover)"
            exit 0
          fi

      # ==================== CONTENT INTEGRITY ====================
      - name: 'Check: Page Title'
        if: matrix.check == 'content-integrity'
        shell: bash
        run: |
          set +e
          PORTFOLIO_URL="${{ steps.urls.outputs.portfolio_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"
          UA='Mozilla/5.0 (GitHubActions VerifyDeployment; +https://github.com/qws941/resume)'

          echo "üìÑ Checking Page Title..."

          HTML=$(curl -fsSL --http1.1 --connect-timeout 10 --retry 3 --retry-delay 2 --retry-all-errors --max-time "$TIMEOUT" -A "$UA" "$PORTFOLIO_URL/" 2>/dev/null)

          if TITLE=$(echo "$HTML" | grep -oPi '<title>\K[^<]+' | head -1); then
            if [ -n "$TITLE" ] && [ ${#TITLE} -gt 10 ]; then
              echo "‚úÖ Page Title: ${TITLE:0:50}..."
              exit 0
            else
              echo "‚ö†Ô∏è  Page Title: Too short or missing"
              exit 0
            fi
          else
            echo "‚ö†Ô∏è  Page Title: Missing from fetched HTML (non-blocking)"
            exit 0
          fi

      - name: 'Check: Open Graph Meta Tags'
        if: matrix.check == 'content-integrity'
        shell: bash
        run: |
          set +e
          PORTFOLIO_URL="${{ steps.urls.outputs.portfolio_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"
          UA='Mozilla/5.0 (GitHubActions VerifyDeployment; +https://github.com/qws941/resume)'

          echo "üìÑ Checking Open Graph Meta Tags..."

          HTML=$(curl -fsSL --http1.1 --connect-timeout 10 --retry 3 --retry-delay 2 --retry-all-errors --max-time "$TIMEOUT" -A "$UA" "$PORTFOLIO_URL/" 2>/dev/null)

          OG_COUNT=0
          [ $(echo "$HTML" | grep -c 'property="og:title"') -gt 0 ] && ((OG_COUNT++))
          [ $(echo "$HTML" | grep -c 'property="og:description"') -gt 0 ] && ((OG_COUNT++))
          [ $(echo "$HTML" | grep -c 'property="og:image"') -gt 0 ] && ((OG_COUNT++))
          [ $(echo "$HTML" | grep -c 'property="og:url"') -gt 0 ] && ((OG_COUNT++))

          if [ $OG_COUNT -ge 4 ]; then
            echo "‚úÖ Open Graph: $OG_COUNT/4 tags"
            exit 0
          elif [ $OG_COUNT -ge 2 ]; then
            echo "‚ö†Ô∏è  Open Graph: $OG_COUNT/4 tags"
            exit 0
          else
            echo "‚ö†Ô∏è  Open Graph: $OG_COUNT/4 tags (non-blocking)"
            exit 0
          fi

      - name: 'Check: OG Image Accessibility'
        if: matrix.check == 'content-integrity'
        shell: bash
        run: |
          set +e
          PORTFOLIO_URL="${{ steps.urls.outputs.portfolio_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"

          echo "üìÑ Checking OG Image Accessibility..."

          if curl -sfI --max-time "$TIMEOUT" "$PORTFOLIO_URL/og-image.webp" 2>/dev/null | grep -q "200"; then
            OG_SIZE=$(curl -sI --max-time "$TIMEOUT" "$PORTFOLIO_URL/og-image.webp" 2>/dev/null | grep -i "content-length" | awk '{print $2}' | tr -d '\r')
            OG_KB=$((${OG_SIZE:-0} / 1024))
            echo "‚úÖ OG Image: Accessible (${OG_KB}KB)"
            exit 0
          else
            echo "‚ùå OG Image: Not accessible"
            exit 1
          fi

      # ==================== PERFORMANCE METRICS ====================
      - name: 'Check: Prometheus Metrics Endpoint'
        if: matrix.check == 'performance'
        shell: bash
        run: |
          set +e
          PORTFOLIO_URL="${{ steps.urls.outputs.portfolio_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"

          echo "üìä Checking Prometheus Metrics Endpoint..."

          if METRICS=$(curl -sf --max-time "$TIMEOUT" "$PORTFOLIO_URL/metrics" 2>/dev/null); then
            METRIC_COUNT=0
            echo "$METRICS" | grep -q "http_requests_total" && ((METRIC_COUNT++))
            echo "$METRICS" | grep -q "http_response_time" && ((METRIC_COUNT++))
            echo "$METRICS" | grep -q "vitals_received" && ((METRIC_COUNT++))
            
            if [ $METRIC_COUNT -ge 2 ]; then
              REQ_TOTAL=$(echo "$METRICS" | grep "http_requests_total" | grep -oP '\d+' | tail -1 || echo "N/A")
              echo "‚úÖ Metrics Endpoint: $METRIC_COUNT metrics, $REQ_TOTAL total requests"
              exit 0
            else
              echo "‚ö†Ô∏è  Metrics Endpoint: Only $METRIC_COUNT/3 metrics found"
              exit 0
            fi
          else
            echo "‚ö†Ô∏è  Metrics Endpoint: Not accessible"
            exit 0
          fi

      - name: 'Check: Gzip/Brotli Compression'
        if: matrix.check == 'performance'
        shell: bash
        run: |
          set +e
          PORTFOLIO_URL="${{ steps.urls.outputs.portfolio_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"

          echo "üìä Checking Compression..."

          ENCODING=$(curl -sI -H "Accept-Encoding: gzip, br" --max-time "$TIMEOUT" "$PORTFOLIO_URL/" 2>/dev/null | grep -i "content-encoding" | head -1 | tr -d '\r')

          if echo "$ENCODING" | grep -qi "br"; then
            echo "‚úÖ Compression: Brotli"
            exit 0
          elif echo "$ENCODING" | grep -qi "gzip"; then
            echo "‚úÖ Compression: Gzip"
            exit 0
          else
            echo "‚ö†Ô∏è  Compression: None detected"
            exit 0
          fi

      - name: 'Check: Cache-Control Headers'
        if: matrix.check == 'performance'
        shell: bash
        run: |
          set +e
          PORTFOLIO_URL="${{ steps.urls.outputs.portfolio_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"

          echo "üìä Checking Cache-Control Headers..."

          CACHE_CONTROL=$(curl -sI --max-time "$TIMEOUT" "$PORTFOLIO_URL/" 2>/dev/null | grep -i "cache-control" | head -1 | tr -d '\r')

          if echo "$CACHE_CONTROL" | grep -qi "max-age"; then
            echo "‚úÖ Cache-Control: ${CACHE_CONTROL#*: }"
            exit 0
          else
            echo "‚ö†Ô∏è  Cache-Control: Not set"
            exit 0
          fi

      # ==================== API ENDPOINTS ====================
      - name: 'Check: Web Vitals Endpoint'
        if: matrix.check == 'api-endpoints'
        shell: bash
        run: |
          set +e
          PORTFOLIO_URL="${{ steps.urls.outputs.portfolio_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"

          echo "üîó Checking Web Vitals Endpoint..."

          VITALS_DATA='{"lcp":1250,"fid":50,"cls":0.05,"url":"/","timestamp":'$(date +%s000)'}'
          if HTTP_CODE=$(curl -sf -X POST --max-time "$TIMEOUT" "$PORTFOLIO_URL/api/vitals" \
            -H "Content-Type: application/json" \
            -d "$VITALS_DATA" \
            -w "%{http_code}" \
            -o /dev/null 2>/dev/null); then
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Vitals Endpoint: HTTP $HTTP_CODE"
              exit 0
            else
              echo "‚ö†Ô∏è  Vitals Endpoint: HTTP $HTTP_CODE"
              exit 0
            fi
          else
            echo "‚ö†Ô∏è  Vitals Endpoint: Not responding"
            exit 0
          fi

      - name: 'Check: robots.txt'
        if: matrix.check == 'api-endpoints'
        shell: bash
        run: |
          set +e
          PORTFOLIO_URL="${{ steps.urls.outputs.portfolio_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"

          echo "üîó Checking robots.txt..."

          if curl -sf --max-time "$TIMEOUT" "$PORTFOLIO_URL/robots.txt" 2>/dev/null | grep -qi "user-agent"; then
            echo "‚úÖ robots.txt: Present and valid"
            exit 0
          else
            echo "‚ö†Ô∏è  robots.txt: Missing or invalid"
            exit 0
          fi

      - name: 'Check: sitemap.xml'
        if: matrix.check == 'api-endpoints'
        shell: bash
        run: |
          set +e
          PORTFOLIO_URL="${{ steps.urls.outputs.portfolio_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"

          echo "üîó Checking sitemap.xml..."

          if curl -sf --max-time "$TIMEOUT" "$PORTFOLIO_URL/sitemap.xml" 2>/dev/null | grep -qi "<urlset"; then
            URL_COUNT=$(curl -sf --max-time "$TIMEOUT" "$PORTFOLIO_URL/sitemap.xml" 2>/dev/null | grep -c "<url>" || echo "0")
            echo "‚úÖ sitemap.xml: $URL_COUNT URLs"
            exit 0
          else
            echo "‚ö†Ô∏è  sitemap.xml: Missing or invalid"
            exit 0
          fi

  verify-job-dashboard:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call' || (github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success')
    name: Verify Job Dashboard (${{ matrix.check }})
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        check:
          - health
          - endpoints
    steps:
      - name: Set URLs
        id: urls
        shell: bash
        run: |
          JOB_DASHBOARD_URL="${{ inputs.job_dashboard_url || github.event.inputs.job_dashboard_url || env.JOB_DASHBOARD_URL }}"
          TIMEOUT="${{ inputs.timeout_seconds || '30' }}"

          echo "job_dashboard_url=$JOB_DASHBOARD_URL" >> $GITHUB_OUTPUT
          echo "timeout=$TIMEOUT" >> $GITHUB_OUTPUT

          echo "üìç Job Dashboard URL: $JOB_DASHBOARD_URL"
          echo "üìç Timeout: ${TIMEOUT}s"

      - name: 'Check: Job Dashboard Health'
        if: matrix.check == 'health'
        shell: bash
        run: |
          set +e
          JOB_DASHBOARD_URL="${{ steps.urls.outputs.job_dashboard_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"
          RETRIES=5
          DELAY=5

          echo "üè• Checking Job Dashboard Health..."

          for i in $(seq 1 $RETRIES); do
            echo "  Attempt $i/$RETRIES..."
            if JOB_HEALTH=$(curl -sf --max-time "$TIMEOUT" "$JOB_DASHBOARD_URL/api/health" 2>/dev/null); then
              JOB_STATUS=$(echo "$JOB_HEALTH" | jq -r '.status // "unknown"' 2>/dev/null)
              JOB_VERSION=$(echo "$JOB_HEALTH" | jq -r '.version // "unknown"' 2>/dev/null)
              DB_STATUS=$(echo "$JOB_HEALTH" | jq -r '.database // "unknown"' 2>/dev/null)
              
              if [ "$JOB_STATUS" = "ok" ]; then
                echo "‚úÖ Job Dashboard Health: $JOB_STATUS (v$JOB_VERSION, DB: $DB_STATUS)"
                exit 0
              fi
            fi
            
            if [ $i -lt $RETRIES ]; then
              echo "  Retrying in ${DELAY}s..."
              sleep $DELAY
            fi
          done

          echo "‚ö†Ô∏è  Job Dashboard Health: May be offline or still starting"
          exit 0

      - name: 'Check: Response Time'
        if: matrix.check == 'health'
        shell: bash
        run: |
          set +e
          JOB_DASHBOARD_URL="${{ steps.urls.outputs.job_dashboard_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"

          echo "‚è±Ô∏è  Measuring Response Time..."

          RESPONSE_TIME=$(curl -sf -o /dev/null -w "%{time_total}" --max-time "$TIMEOUT" "$JOB_DASHBOARD_URL/" 2>/dev/null || echo "0")
          RESPONSE_MS=$(echo "$RESPONSE_TIME * 1000" | bc | cut -d. -f1)

          if [ "$RESPONSE_MS" -lt 500 ]; then
            echo "‚úÖ Response Time: ${RESPONSE_MS}ms (<500ms)"
            exit 0
          elif [ "$RESPONSE_MS" -lt 1000 ]; then
            echo "‚ö†Ô∏è  Response Time: ${RESPONSE_MS}ms (500-1000ms)"
            exit 0
          else
            echo "‚ùå Response Time: ${RESPONSE_MS}ms (>1000ms)"
            exit 1
          fi

      - name: 'Check: API Endpoints'
        if: matrix.check == 'endpoints'
        shell: bash
        run: |
          set +e
          JOB_DASHBOARD_URL="${{ steps.urls.outputs.job_dashboard_url }}"
          TIMEOUT="${{ steps.urls.outputs.timeout }}"

          echo "üîó Checking API Endpoints..."

          # Check main endpoint
          if curl -sf --max-time "$TIMEOUT" -o /dev/null "$JOB_DASHBOARD_URL/" 2>/dev/null; then
            echo "‚úÖ Main Endpoint: HTTP 200"
          else
            echo "‚ö†Ô∏è  Main Endpoint: Not accessible"
          fi

          # Check jobs endpoint
          if curl -sf --max-time "$TIMEOUT" -o /dev/null "$JOB_DASHBOARD_URL/api/jobs" 2>/dev/null; then
            echo "‚úÖ Jobs API Endpoint: HTTP 200"
          else
            echo "‚ö†Ô∏è  Jobs API Endpoint: Not accessible"
          fi

  summary:
    if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call' || (github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success')) && always()
    name: Verification Summary
    runs-on: ubuntu-latest
    needs: [verify-portfolio, verify-job-dashboard]
    steps:
      - name: Check Status
        shell: bash
        run: |
          echo "üéØ Verification Summary"
          echo "======================="
          echo ""
          echo "Portfolio Verification: ${{ needs.verify-portfolio.result }}"
          echo "Job Dashboard Verification: ${{ needs.verify-job-dashboard.result }}"
          echo ""

          if [ "${{ needs.verify-portfolio.result }}" = "success" ] && [ "${{ needs.verify-job-dashboard.result }}" = "success" ]; then
            echo "‚úÖ All verification checks passed!"
            exit 0
          elif [ "${{ needs.verify-portfolio.result }}" = "success" ]; then
            echo "‚ö†Ô∏è  Portfolio verified, but Job Dashboard may have issues"
            exit 0
          else
            echo "‚ö†Ô∏è  Some verification checks failed or were skipped"
            exit 1
          fi

  e2e-deploy-verify:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call' || (github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success')
    name: E2E Deploy Verification
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [summary]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Run deploy verification E2E
        run: SKIP_WEBSERVER=1 PLAYWRIGHT_BASE_URL=https://resume.jclee.me npx playwright test deploy-verification --project=chromium

      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
          if-no-files-found: ignore
