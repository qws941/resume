name: Deploy Job Worker

on:
  workflow_dispatch:

concurrency:
  group: deploy-job-worker-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy job worker (production)
    runs-on: ubuntu-latest
    environment:
      name: production
    permissions:
      contents: read
    timeout-minutes: 15
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Verify required secrets
        run: |
          if [ -z "$CLOUDFLARE_API_TOKEN" ] || [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "::error::Missing Cloudflare deployment secrets"
            exit 1
          fi

      - name: Resolve job worker script name
        id: resolve-script
        run: |
          set -euo pipefail
          ZONE_ID=$(curl -fsS -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" -H "Content-Type: application/json" "https://api.cloudflare.com/client/v4/zones?name=jclee.me&status=active" | jq -r '.result[0].id')
          if [ -z "${ZONE_ID}" ] || [ "${ZONE_ID}" = "null" ]; then
            echo "::error::Unable to resolve zone id for jclee.me"
            exit 1
          fi

          SCRIPT_NAME=$(curl -fsS -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" -H "Content-Type: application/json" "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/workers/routes" | jq -r '.result[] | select(.pattern=="resume.jclee.me/job/*") | .script' | head -1)
          if [ -z "${SCRIPT_NAME}" ] || [ "${SCRIPT_NAME}" = "null" ]; then
            echo "::error::Unable to find worker script for route resume.jclee.me/job/*"
            exit 1
          fi

          echo "zone_id=${ZONE_ID}" >> "$GITHUB_OUTPUT"
          echo "script_name=${SCRIPT_NAME}" >> "$GITHUB_OUTPUT"

      - name: Show existing schedules
        run: |
          set -euo pipefail
          SCRIPT_NAME="${{ steps.resolve-script.outputs.script_name }}"
          curl -fsS -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" -H "Content-Type: application/json" "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/workers/scripts/${SCRIPT_NAME}/schedules" | jq

      - name: Remove all schedules
        run: |
          set -euo pipefail
          SCRIPT_NAME="${{ steps.resolve-script.outputs.script_name }}"
          curl -fsS -X PUT -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" -H "Content-Type: application/json" "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/workers/scripts/${SCRIPT_NAME}/schedules" --data '[]' | jq

      - name: Verify schedules removed
        run: |
          set -euo pipefail
          SCRIPT_NAME="${{ steps.resolve-script.outputs.script_name }}"
          COUNT=$(curl -fsS -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" -H "Content-Type: application/json" "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/workers/scripts/${SCRIPT_NAME}/schedules" | jq '.result | length')
          echo "remaining_schedules=${COUNT}" >> "$GITHUB_OUTPUT"
          if [ "${COUNT}" != "0" ]; then
            echo "::error::Schedules still remain on worker ${SCRIPT_NAME}: ${COUNT}"
            exit 1
          fi

      - name: Post summary
        run: |
          echo "## Job Worker Schedule Removal Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Worker: ${{ steps.resolve-script.outputs.script_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: production" >> $GITHUB_STEP_SUMMARY
          echo "- Remaining schedules: 0" >> $GITHUB_STEP_SUMMARY
