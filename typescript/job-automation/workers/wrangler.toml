name = "job"
main = "src/index.js"
compatibility_date = "2026-02-21"

# --- Resource bindings (inherited by all environments) ---

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "job-dashboard-db"
database_id = "c858dda6-b752-4e12-b60c-2886e9483cc7"

# KV Namespace for sessions and cache
[[kv_namespaces]]
binding = "SESSIONS"
id = "2b81b9b02dc34f518d2ca9552804bfef"

# KV Namespace for rate limiting
[[kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "fe51b0f1c2c44841b4895e8747cb408a"

# KV Namespace for webhook nonce replay protection
[[kv_namespaces]]
binding = "NONCE_KV"
id = "3e282b1b906c474aadcc947a06f0c1ad"

# Queue bindings for async task processing
[[queues.producers]]
binding = "CRAWL_TASKS"
queue = "crawl-tasks"

[[queues.consumers]]
queue = "crawl-tasks"
max_batch_size = 10
max_retries = 5

# --- Shared environment variables (inherited by all environments, overridable per-env) ---
[vars]
ENVIRONMENT = "production"
LOKI_URL = "https://grafana.jclee.me/api/datasources/proxy/uid/cfakfiakcs0zka/loki/api/v1/push"
ELASTICSEARCH_INDEX = "resume-logs-job-worker"

# Secrets (set via `wrangler secret put`):
# ANTHROPIC_API_KEY, SLACK_TOKEN, SLACK_WEBHOOK_URL, JWT_SECRET, WEBHOOK_SECRET

# --- Production environment ---
# D1/KV/Queue bindings inherited from top-level (no need to redeclare).
[env.production]
routes = [{ pattern = "resume.jclee.me/job/*", zone_name = "jclee.me" }]


[env.production.vars]
SLACK_CHANNEL = "C09TJUXC7Q8"

# --- Staging environment ---
# D1/KV/Queue bindings inherited from top-level (currently shares production resources).
# TODO(staging-isolation): Create dedicated staging resources for environment isolation:
#   - D1: job-dashboard-db-staging
#   - KV: sessions-staging, rate-limit-kv-staging, nonce-kv-staging
#   - Queue: crawl-tasks-staging
[env.staging]
name = "job-dashboard-staging"

[env.staging.vars]
ENVIRONMENT = "staging"
ELASTICSEARCH_INDEX = "resume-logs-job-worker-staging"
