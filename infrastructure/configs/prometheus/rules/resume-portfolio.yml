# Prometheus Recording Rules for Resume Portfolio
# Part of Issue #90: Observability implementation
#
# ALERTING POLICY:
#   Alerting is managed exclusively by Grafana Managed Alerts.
#   See: infrastructure/configs/grafana/alert-rules.yaml
#   This file contains ONLY recording rules (pre-computed metrics).
#
# WHY SINGLE ALERTING PLANE:
#   Previously, 9 Prometheus alerting rules duplicated 7 of 11 Grafana alerts
#   with identical conditions/thresholds. Consolidating to Grafana as the single
#   alerting plane eliminates duplicate notifications and provides:
#   - Unified alert management UI (Grafana)
#   - Loki-based log alerts (not possible in Prometheus)
#   - Multi-datasource correlation (Prometheus + Loki + CF analytics)
#   - Severity-routed Slack notifications via contact points
#
# NOTE ON METRICS AVAILABILITY:
#   The CF Worker exposes /metrics in Prometheus text format, but Prometheus
#   currently only performs blackbox probes (up{job="resume"}). Metrics like
#   http_requests_total{job="resume"} are NOT scraped into Prometheus.
#   These recording rules will produce data only once push-based metrics
#   or direct scraping is configured. See P0-M1 in docs/ for the roadmap.

groups:
  # ========================================
  # Recording Rules (pre-computed metrics)
  # ========================================
  - name: resume_recording_rules
    interval: 15s
    rules:
      # Error rate as a ratio (0-1) over 5-minute window
      - record: resume:http_error_rate:ratio_rate5m
        expr: |
          sum(rate(http_requests_error{job="resume"}[5m]))
          /
          (sum(rate(http_requests_total{job="resume"}[5m])) > 0)

      # Success rate as a ratio (0-1) over 5-minute window
      - record: resume:http_success_rate:ratio_rate5m
        expr: |
          sum(rate(http_requests_success{job="resume"}[5m]))
          /
          (sum(rate(http_requests_total{job="resume"}[5m])) > 0)

      # Rolling 1-hour availability (success / total)
      - record: resume:availability:ratio_rate1h
        expr: |
          sum(rate(http_requests_success{job="resume"}[1h]))
          /
          (sum(rate(http_requests_total{job="resume"}[1h])) > 0)

      # Request rate per second (5m smoothed)
      - record: resume:http_requests:rate5m
        expr: sum(rate(http_requests_total{job="resume"}[5m]))

      # Workflow failure rate (30m window)
      - record: resume:workflow_failure_rate:ratio_rate30m
        expr: |
          sum(rate(workflow_executions_failed_total{job="job-automation"}[30m]))
          /
          (sum(rate(workflow_executions_total{job="job-automation"}[30m])) > 0)
