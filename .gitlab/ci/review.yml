include:
  - component: gitlab.com/nagyv/gitlab-opencode/opencode@1.0.0
    inputs:
      config_dir: ${CI_PROJECT_DIR}
      auth_json: $OPENCODE_AUTH_JSON
      message: |
        Review this merge request and post a comment with findings.

        Focus on: security issues, bugs, performance problems.
        Be concise. Use markdown formatting.

        If changes look good, say so briefly.
      stage: validate
      job_prefix: oracle-review

oracle-review-post:
  stage: validate
  needs: [opencode-oracle-review]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  script:
    - |
      REVIEW=$(cat opencode-oracle-review.out 2>/dev/null || echo "Review not available")
      curl -s -X POST "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes" \
        -H "JOB-TOKEN: ${CI_JOB_TOKEN}" \
        -H "Content-Type: application/json" \
        -d "{\"body\": \"## :crystal_ball: Oracle Review\n\n${REVIEW}\n\n---\n*Automated by OpenCode*\"}"
  allow_failure: true
