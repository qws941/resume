.cli:lint:
  stage: validate
  extends: .go-setup
  cache:
    key: go-${CI_COMMIT_REF_SLUG}
    paths:
      - .go/pkg/mod/
      - .go/build-cache/
  script:
    - cd cmd/resume-cli
    - go vet ./...
    - |
      if command -v golangci-lint &> /dev/null; then
        golangci-lint run --timeout 5m
      else
        echo "golangci-lint not installed, skipping"
      fi

.cli:test:
  stage: test
  extends: .go-setup
  cache:
    key: go-${CI_COMMIT_REF_SLUG}
    paths:
      - .go/pkg/mod/
      - .go/build-cache/
  script:
    - cd cmd/resume-cli
    - go test -v -race -coverprofile=coverage.out ./...
    - go tool cover -func=coverage.out
  artifacts:
    when: always
    paths:
      - cmd/resume-cli/coverage.out
    expire_in: 7 days
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'

.cli:build:
  stage: build
  extends: .go-setup
  cache:
    key: go-${CI_COMMIT_REF_SLUG}
    paths:
      - .go/pkg/mod/
      - .go/build-cache/
  script:
    - cd cmd/resume-cli
    - |
      VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
      COMMIT=$(git rev-parse --short HEAD)
      BUILD_TIME=$(date -u '+%Y-%m-%dT%H:%M:%SZ')

      LDFLAGS="-s -w -X main.version=${VERSION} -X main.commit=${COMMIT} -X main.buildTime=${BUILD_TIME}"

      echo "Building resume-cli ${VERSION} (${COMMIT})"

      GOOS=linux GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o ../../dist/resume-cli-linux-amd64 .
      GOOS=linux GOARCH=arm64 go build -ldflags "${LDFLAGS}" -o ../../dist/resume-cli-linux-arm64 .
      GOOS=darwin GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o ../../dist/resume-cli-darwin-amd64 .
      GOOS=darwin GOARCH=arm64 go build -ldflags "${LDFLAGS}" -o ../../dist/resume-cli-darwin-arm64 .
    - ls -la ../../dist/
  artifacts:
    paths:
      - dist/resume-cli-*
    expire_in: 7 days

.cli:integration:
  stage: test
  extends: .go-setup
  cache:
    key: go-${CI_COMMIT_REF_SLUG}
    paths:
      - .go/pkg/mod/
      - .go/build-cache/
  script:
    - cd cmd/resume-cli
    - go test -v -tags=integration ./internal/automation/adapters/...
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
    - when: manual
